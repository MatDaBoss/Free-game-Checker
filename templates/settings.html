{% extends "base.html" %}

{% block title %}Settings - Free Game Checker{% endblock %}

{% block content %}
<div class="card">
    <h2>ğŸ“§ Email Configuration</h2>
    <div class="form-group">
        <label>Sender Email</label>
        <input type="email" value="{{ config.email_sender }}" disabled style="background: #f8f9fa;">
        <small style="color: #666;">This is set during installation</small>
    </div>
    
    <div class="form-group">
        <label>Gmail App Password</label>
        <input type="password" id="email-password" placeholder="Enter your 16-character app password">
        <small style="color: #666;">Get this from <a href="https://myaccount.google.com/apppasswords" target="_blank">Google App Passwords</a></small>
    </div>
    
    <button class="btn" onclick="saveEmailConfig()">ğŸ’¾ Save Email Settings</button>
    <div id="email-result" style="margin-top: 15px;"></div>
</div>

<div class="card">
    <h2>ğŸ“… Schedule Configuration</h2>
    <div class="form-group">
        <label>Day of Week</label>
        <select id="schedule-day">
            <option value="monday" {% if config.schedule_day == 'monday' %}selected{% endif %}>Monday</option>
            <option value="tuesday" {% if config.schedule_day == 'tuesday' %}selected{% endif %}>Tuesday</option>
            <option value="wednesday" {% if config.schedule_day == 'wednesday' %}selected{% endif %}>Wednesday</option>
            <option value="thursday" {% if config.schedule_day == 'thursday' %}selected{% endif %}>Thursday</option>
            <option value="friday" {% if config.schedule_day == 'friday' %}selected{% endif %}>Friday</option>
            <option value="saturday" {% if config.schedule_day == 'saturday' %}selected{% endif %}>Saturday</option>
            <option value="sunday" {% if config.schedule_day == 'sunday' %}selected{% endif %}>Sunday</option>
        </select>
    </div>
    
    <div class="form-group">
        <label>Time (24-hour format)</label>
        <input type="time" id="schedule-time" value="{{ config.schedule_time }}">
    </div>
    
    <button class="btn" onclick="saveSchedule()">ğŸ’¾ Save Schedule</button>
    <div id="schedule-result" style="margin-top: 15px;"></div>
    
    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; color: #856404;">
        âš ï¸ <strong>Note:</strong> After changing the schedule, you need to restart the service:
        <code style="display: block; margin-top: 10px; padding: 10px; background: white; border-radius: 5px;">sudo systemctl restart free-game-checker</code>
    </div>
</div>

<div class="card">
    <h2>ğŸ® Game Stores to Monitor</h2>
    <p style="color: #666; margin-bottom: 20px;">Select which game stores you want to monitor for free games</p>
    
    <div class="checkbox-group" id="stores-list">
        {% for store in ['Epic Games Store', 'Steam', 'GOG', 'Humble Bundle', 'Itch.io', 'Nintendo Switch', 'Xbox Store', 'Google Play Games', 'Prime Gaming'] %}
        <div class="checkbox-item">
            <input type="checkbox" id="store-{{ loop.index }}" value="{{ store }}" 
                   {% if store in config.enabled_stores %}checked{% endif %}>
            <label for="store-{{ loop.index }}" style="margin: 0; cursor: pointer;">
                {% if store == 'Nintendo Switch' %}ğŸ•¹ï¸
                {% elif store == 'Xbox Store' %}ğŸ®
                {% elif store == 'Google Play Games' %}ğŸ“±
                {% elif store == 'Prime Gaming' %}âŒ
                {% else %}ğŸ–¥ï¸{% endif %}
                {{ store }}
            </label>
        </div>
        {% endfor %}
    </div>
    
    <button class="btn" onclick="saveStores()" style="margin-top: 20px;">ğŸ’¾ Save Store Selection</button>
    <div id="stores-result" style="margin-top: 15px;"></div>
</div>

<div class="card">
    <h2>â• Add Custom Store (Advanced)</h2>
    <p style="color: #666; margin-bottom: 20px;">Add your own game store to monitor</p>
    
    <div class="form-group">
        <label>Store Name</label>
        <input type="text" id="custom-name" placeholder="e.g., My Favorite Store">
    </div>
    
    <div class="form-group">
        <label>Store URL</label>
        <input type="text" id="custom-url" placeholder="https://example.com/free-games">
    </div>
    
    <div class="form-group">
        <label>Search Pattern (text to look for)</label>
        <input type="text" id="custom-pattern" placeholder="e.g., FREE, $0.00, Gratis">
        <small style="color: #666;">The word or phrase that indicates a free game on this store's page</small>
    </div>
    
    <button class="btn" onclick="addCustomStore()">â• Add Custom Store</button>
    
    <div id="custom-stores-list" style="margin-top: 20px;">
        <h3 style="margin-bottom: 15px;">Your Custom Stores</h3>
        <div id="custom-stores-container"></div>
    </div>
</div>

<div class="card">
    <h2>ğŸ‘¥ Email Recipients</h2>
    <p style="color: #666; margin-bottom: 20px;">Manage who receives the free game notifications</p>
    
    <div class="form-group">
        <label>Add New Recipient</label>
        <div style="display: flex; gap: 10px;">
            <input type="email" id="new-recipient" placeholder="email@example.com" style="margin-bottom: 0;">
            <button class="btn" onclick="addRecipient()">â• Add</button>
        </div>
    </div>
    
    <div id="recipients-list" style="margin-top: 20px;">
        <h3 style="margin-bottom: 15px;">Current Recipients</h3>
        {% for email in recipients %}
        <div class="list-item">
            <span>{{ email }}</span>
            <button class="btn btn-danger" onclick="removeRecipient('{{ email }}')">ğŸ—‘ï¸ Remove</button>
        </div>
        {% endfor %}
    </div>
    
    <div id="recipients-result" style="margin-top: 15px;"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Load custom stores on page load
document.addEventListener('DOMContentLoaded', function() {
    loadCustomStores();
});

function showResult(elementId, message, isError = false) {
    const resultDiv = document.getElementById(elementId);
    resultDiv.innerHTML = `<div class="alert ${isError ? 'alert-error' : 'alert-success'}">${message}</div>`;
    setTimeout(() => {
        resultDiv.innerHTML = '';
    }, 5000);
}

function saveEmailConfig() {
    const password = document.getElementById('email-password').value;
    
    if (!password) {
        showResult('email-result', 'Please enter your app password', true);
        return;
    }
    
    fetch('/api/config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            email_password: password
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showResult('email-result', 'âœ… Email configuration saved!');
            document.getElementById('email-password').value = '';
        } else {
            showResult('email-result', 'âŒ Error: ' + (data.error || 'Unknown error'), true);
        }
    })
    .catch(error => {
        showResult('email-result', 'âŒ Network error: ' + error.message, true);
    });
}

function saveSchedule() {
    const day = document.getElementById('schedule-day').value;
    const time = document.getElementById('schedule-time').value;
    
    fetch('/api/config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            schedule_day: day,
            schedule_time: time
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showResult('schedule-result', 'âœ… Schedule saved! Remember to restart the service.');
        } else {
            showResult('schedule-result', 'âŒ Error: ' + (data.error || 'Unknown error'), true);
        }
    })
    .catch(error => {
        showResult('schedule-result', 'âŒ Network error: ' + error.message, true);
    });
}

function saveStores() {
    const checkboxes = document.querySelectorAll('#stores-list input[type="checkbox"]');
    const enabledStores = [];
    
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            enabledStores.push(checkbox.value);
        }
    });
    
    fetch('/api/config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            enabled_stores: enabledStores
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showResult('stores-result', `âœ… Now monitoring ${enabledStores.length} store(s)`);
        } else {
            showResult('stores-result', 'âŒ Error: ' + (data.error || 'Unknown error'), true);
        }
    })
    .catch(error => {
        showResult('stores-result', 'âŒ Network error: ' + error.message, true);
    });
}

function addRecipient() {
    const email = document.getElementById('new-recipient').value.trim();
    
    if (!email || !email.includes('@')) {
        showResult('recipients-result', 'Please enter a valid email address', true);
        return;
    }
    
    fetch('/api/recipients', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ email: email })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showResult('recipients-result', 'âœ… ' + data.message);
            setTimeout(() => location.reload(), 1500);
        } else {
            showResult('recipients-result', 'âŒ Error: ' + (data.error || 'Unknown error'), true);
        }
    })
    .catch(error => {
        showResult('recipients-result', 'âŒ Network error: ' + error.message, true);
    });
}

function removeRecipient(email) {
    if (!confirm(`Remove ${email} from recipients?`)) {
        return;
    }
    
    fetch('/api/recipients', {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ email: email })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showResult('recipients-result', 'âœ… ' + data.message);
            setTimeout(() => location.reload(), 1500);
        } else {
            showResult('recipients-result', 'âŒ Error: ' + (data.error || 'Unknown error'), true);
        }
    })
    .catch(error => {
        showResult('recipients-result', 'âŒ Network error: ' + error.message, true);
    });
}

function loadCustomStores() {
    fetch('/api/stores/custom')
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('custom-stores-container');
        if (data.stores && data.stores.length > 0) {
            container.innerHTML = data.stores.map(store => `
                <div class="list-item">
                    <div>
                        <strong>${store.name}</strong><br>
                        <small style="color: #666;">${store.url}</small>
                    </div>
                    <button class="btn btn-danger" onclick="removeCustomStore(${store.id})">ğŸ—‘ï¸ Remove</button>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<p style="color: #666;">No custom stores added yet</p>';
        }
    });
}

function addCustomStore() {
    const name = document.getElementById('custom-name').value.trim();
    const url = document.getElementById('custom-url').value.trim();
    const pattern = document.getElementById('custom-pattern').value.trim();
    
    if (!name || !url || !pattern) {
        alert('Please fill in all fields');
        return;
    }
    
    fetch('/api/stores/custom', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name, url, pattern })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('âœ… ' + data.message);
            document.getElementById('custom-name').value = '';
            document.getElementById('custom-url').value = '';
            document.getElementById('custom-pattern').value = '';
            loadCustomStores();
        } else {
            alert('âŒ Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('âŒ Network error: ' + error.message);
    });
}

function removeCustomStore(id) {
    if (!confirm('Remove this custom store?')) {
        return;
    }
    
    fetch('/api/stores/custom', {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ id: id })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('âœ… ' + data.message);
            loadCustomStores();
        } else {
            alert('âŒ Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('âŒ Network error: ' + error.message);
    });
}
</script>
{% endblock %}
